---
layout: post
title: 'JPA - Entity, 영속성'
date: '2016-12-06 20:30:01 -0500'
categories: ORM
fb_title: java_day5
---

'자바 ORM 표준 JPA 프로그래밍'을 보고 정리한 내용을 포스팅 합니다.

# EntityManagerFactory , EntityManager

* Hibernate에서는 SessionFactory(EntityManagerFactory), Session(EntityManager)으로 불리운다.

* 엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하다.(thread-safe)

* 엔티티 매니저는 여러 스레드가 동시에 접근하면 동시성 문제가 발생하므로 스레드 간에 절대 공유하면 안된다.

# 영속성 컨텍스트

* 영속성 컨텍스트란 **엔티티(Entity)를 영구 저장** 하는 환경을 말한다.
엔티티 매니저로 엔티티를 저장하거나 조회하면 엔티티 매니저는 영속성 컨텍스트에 엔티티를 보관하고 관리한다.

* 영속성 컨텍스트는 엔티티 매니저(Session)를 생성할 때 하나 만들어진다. 그리고 엔티티 매니저(Session)를 통해서 영속성 컨텍스트에 접근할 수 있고 영속성 컨텍스트를 관리 할 수 있다.

# 엔티티의 생명주기

![entitylifecycle](../images/entity_lifecycle.jpg)

> * 비영속(new/transient) : 영속성 컨텍스트와 전혀 관계가 없는 상태  
  * 영속(merged) : 영속성 컨텍스트에 저장된 상태
  * 준영속(detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태
  * 삭제(removed) : 삭제된 상태

### 비영속

* 순수한 객체 상태이며 아직 저장하지 않았다.

* 영속성 컨텍스트나 데이터베이스와는 전혀 관련이 없는 상태

### 영속

* 엔티티 매니저(Session)를 통해서 엔티티를 영속성 컨텍스트에 저장했다.

* 영속성 컨텍스트가 관리하는 엔티티를 영속 상태라 한다.

* **ORM을 사용해서 조회한 엔티티** 도 영속성 컨텍스트가 관리하는 **영속 상태** 이다.

``` java
// hibernate로 조회한 엔티티도 영속 상태이다.
@Autowried SessionFactory sessionFactory
...

public Member getMember(Long id) {
  Session session = sessionFactory.getCurrentSession();

  // 영속화 된 상태의 Member Entity
  Member member = session.createCriteria(Member.class)
         .add(Restrictions.eq("id", id))
         .uniqueResult();

  return member
}

```

* 영속 상태의 Entity의 setter 메소드를 호출하면 트랜잭션이 끝나는 순간 **DB에 결과가 반영된다.**

### 준영속

* 영속성 컨텍스트가 관리하던 영속 상태의 엔티티를 영속성 컨텍스트가 관리하지 않으면 준영속 상태가 된다.

* session.close() 세션 종료, session.clear() 세션 초기화로 준영속 상태로 만들 수 있다.

### 삭제

* 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제한다.

# 영속성 컨텍스트의 특징
